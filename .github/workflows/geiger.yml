name: Geiger

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read

jobs:
  geiger:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      GEIGER_MANIFEST_DIR: mobile_verifier
      CARGO_BINARY: cargo-geiger
      CARGO_BINARY_VERSION: 0.13.0
      UNSAFE_THRESHOLD: 20  # Fail if unsafe code increases by more than this

    steps:
      - name: Setup | Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for bypass label
        id: check-label
        run: |
          if gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name' 2>/dev/null | grep -qx 'geiger-reviewed'; then
            echo "bypass=true" >> $GITHUB_OUTPUT
            echo "âœ“ Found 'geiger-reviewed' label - Geiger will run in informational mode"
          else
            echo "bypass=false" >> $GITHUB_OUTPUT
            echo "âœ— No bypass label - Geiger will enforce threshold"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        if: github.event_name == 'pull_request'

      - name: Setup | Rust
        uses: dtolnay/rust-toolchain@7b1c307e0dcbda6122208f10795a713336a9b35a # stable
        with:
          toolchain: stable

      - name: Setup | Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Setup | Cache
        uses: Swatinem/rust-cache@82a92a6e8fbeee089604da2575dc567ae9ddeaab # v2.7.5

      - name: Setup | Restore cargo binary from cache
        id: cache-binary
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: /home/runner/.cargo/bin/${{ env.CARGO_BINARY }}
          key: ${{ runner.os }}-${{ env.CARGO_BINARY }}-${{ env.CARGO_BINARY_VERSION }}
          restore-keys: |
            ${{ runner.os }}-${{ env.CARGO_BINARY }}-

      - name: Setup | Check cache status
        run: |
          if [ "${{ steps.cache-binary.outputs.cache-hit }}" == "true" ]; then
            echo "âœ“ Cache hit! ${CARGO_BINARY} binary restored from cache"
            ls -lh /home/runner/.cargo/bin/${CARGO_BINARY}
          else
            echo "âœ— Cache miss - will install ${CARGO_BINARY}"
          fi

      - name: Setup | Install cargo binary
        if: steps.cache-binary.outputs.cache-hit != 'true'
        run: |
          echo "Cache miss - installing ${CARGO_BINARY} ${CARGO_BINARY_VERSION} (this will take ~3-5 minutes)..."
          cargo install ${CARGO_BINARY} --version ${CARGO_BINARY_VERSION} --locked

      - name: Setup | Save cargo binary to cache
        if: always() && steps.cache-binary.outputs.cache-hit != 'true'
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: /home/runner/.cargo/bin/${{ env.CARGO_BINARY }}
          key: ${{ runner.os }}-${{ env.CARGO_BINARY }}-${{ env.CARGO_BINARY_VERSION }}

      - name: Geiger | Detect changed packages
        id: detect-packages
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Fetching main branch for comparison..."
          git fetch origin main --depth=100
          
          echo "Detecting changed workspace packages..."
          # Get list of all workspace members
          WORKSPACE_MEMBERS=$(cargo metadata --format-version=1 --no-deps | jq -r '.workspace_members[] | split("#")[0] | split("/")[-1]')
          
          # Find packages with changes
          CHANGED_PACKAGES=""
          for pkg in $WORKSPACE_MEMBERS; do
            # Check if package directory has changes
            if git diff --name-only origin/main...${{ github.sha }} | grep -q "^${pkg}/"; then
              echo "  ğŸ“¦ Changed: $pkg"
              CHANGED_PACKAGES="$CHANGED_PACKAGES $pkg"
            fi
          done
          
          # If no packages changed, scan the default package
          if [ -z "$CHANGED_PACKAGES" ]; then
            echo "No workspace packages changed, using default: $GEIGER_MANIFEST_DIR"
            CHANGED_PACKAGES="$GEIGER_MANIFEST_DIR"
          fi
          
          echo "packages=$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
          echo ""
          echo "Will scan packages: $CHANGED_PACKAGES"

      - name: Geiger | Run on main branch (baseline)
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Checking out main branch..."
          git checkout origin/main
          
          echo "Running geiger on baseline packages..."
          echo "0" > /tmp/baseline_total.txt
          
          for pkg in ${{ steps.detect-packages.outputs.packages }}; do
            echo "  Scanning $pkg on main branch..."
            MANIFEST_PATH="$GITHUB_WORKSPACE/$pkg/Cargo.toml"
            if [ -f "$MANIFEST_PATH" ]; then
              cargo geiger --manifest-path "$MANIFEST_PATH" --all-targets --locked 2>/dev/null > /tmp/baseline_${pkg}.txt || true
              # Extract unsafe count (2nd column, numerator)
              COUNT=$(grep -v '^$' /tmp/baseline_${pkg}.txt | tail -1 | awk '{print $2}' | cut -d'/' -f1 | tr -d '\n' | tr -d ' ' || echo "0")
              echo "$pkg: $COUNT unsafe expressions"
              TOTAL=$(cat /tmp/baseline_total.txt)
              echo $((TOTAL + COUNT)) > /tmp/baseline_total.txt
            fi
          done
          
          echo ""
          echo "Total baseline unsafe: $(cat /tmp/baseline_total.txt)"
          cat /tmp/baseline_total.txt > /tmp/baseline.txt

      - name: Geiger | Run on PR branch (current)
        shell: bash
        run: |
          set -euo pipefail
          
          echo "Checking out PR branch..."
          git checkout ${{ github.sha }}
          
          echo "Running geiger on PR packages..."
          echo "0" > /tmp/current_total.txt
          
          for pkg in ${{ steps.detect-packages.outputs.packages }}; do
            echo "  Scanning $pkg on PR branch..."
            MANIFEST_PATH="$GITHUB_WORKSPACE/$pkg/Cargo.toml"
            if [ -f "$MANIFEST_PATH" ]; then
              cargo geiger --manifest-path "$MANIFEST_PATH" --all-targets --locked 2>/dev/null > /tmp/current_${pkg}.txt || true
              # Extract unsafe count (2nd column, numerator)
              COUNT=$(grep -v '^$' /tmp/current_${pkg}.txt | tail -1 | awk '{print $2}' | cut -d'/' -f1 | tr -d '\n' | tr -d ' ' || echo "0")
              echo "$pkg: $COUNT unsafe expressions"
              TOTAL=$(cat /tmp/current_total.txt)
              echo $((TOTAL + COUNT)) > /tmp/current_total.txt
            fi
          done
          
          echo ""
          echo "Total current unsafe: $(cat /tmp/current_total.txt)"
          cat /tmp/current_total.txt > /tmp/current.txt

      - name: Geiger | Compare unsafe counts
        shell: bash
        env:
          GEIGER_BYPASS: ${{ steps.check-label.outputs.bypass }}
        run: |
          set -euo pipefail
          
          # Read aggregated totals
          baseline_unsafe=$(cat /tmp/baseline.txt | tr -d '\n' | tr -d ' ')
          current_unsafe=$(cat /tmp/current.txt | tr -d '\n' | tr -d ' ')
          
          echo "=== Scanned packages ==="
          echo "Packages: ${{ steps.detect-packages.outputs.packages }}"
          echo ""
          echo "=== Extracted values ==="
          echo "baseline_unsafe: '$baseline_unsafe'"
          echo "current_unsafe: '$current_unsafe'"
          echo ""
          
          # Validate extraction
          if [ -z "$baseline_unsafe" ] || [ -z "$current_unsafe" ]; then
            echo "âŒ ERROR: Failed to extract unsafe counts from geiger output"
            echo "This usually means the output format changed or parsing failed."
            exit 1
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Unsafe Code Analysis Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Baseline (main):  $baseline_unsafe unsafe items"
          echo "Current (PR):     $current_unsafe unsafe items"
          echo "Threshold:        Â±$UNSAFE_THRESHOLD items"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$current_unsafe" -gt "$baseline_unsafe" ]; then
            delta=$((current_unsafe - baseline_unsafe))
            percent=$(awk "BEGIN {printf \"%.1f\", ($delta / $baseline_unsafe) * 100}")

            if [ "$delta" -gt "$UNSAFE_THRESHOLD" ]; then
              echo ""
              echo "âŒ FAILED: Unsafe code increased by $delta items (+${percent}%)"
              echo ""
              echo "This exceeds the threshold of $UNSAFE_THRESHOLD items."
              echo ""
              echo "âš ï¸  Possible causes:"
              echo "  â€¢ New dependency with significant unsafe code"
              echo "  â€¢ Major version bump with architectural changes"
              echo "  â€¢ Feature flag enabling unsafe functionality"
              echo "  â€¢ FFI bindings or low-level optimizations"
              echo ""
              echo "ğŸ“‹ Required actions:"
              echo "  1. Identify which dependency/code added unsafe items"
              echo "  2. Review the unsafe code for correctness and necessity"
              echo "  3. Document safety invariants and justification"
              echo "  4. Consider alternatives with less unsafe code"
              echo "  5. Get security team review if adding new dependencies"
              echo ""
              
              if [ "$GEIGER_BYPASS" == "true" ]; then
                echo "âš ï¸  Normally this would FAIL, but 'geiger-reviewed' label is present"
                echo "âœ… PASSED (bypassed by manual review)"
              else
                exit 1
              fi
            else
              echo ""
              echo "âš ï¸  WARNING: Unsafe code increased by $delta items (+${percent}%)"
              echo ""
              echo "This is below the threshold of $UNSAFE_THRESHOLD items, so the check passes."
              echo "However, please review the unsafe code additions carefully."
              echo ""
              echo "âœ… PASSED (with warning)"
            fi
            
          elif [ "$current_unsafe" -lt "$baseline_unsafe" ]; then
            delta=$((baseline_unsafe - current_unsafe))
            percent=$(awk "BEGIN {printf \"%.1f\", ($delta / $baseline_unsafe) * 100}")
            echo ""
            echo "ğŸ‰ EXCELLENT: Unsafe code decreased by $delta items (-${percent}%)"
            echo ""
            echo "Great work improving code safety! This PR makes the codebase safer."
            echo ""
            echo "Possible improvements:"
            echo "  âœ“ Removed unnecessary unsafe code"
            echo "  âœ“ Replaced unsafe operations with safe alternatives"
            echo "  âœ“ Upgraded to dependencies with better safety"
            echo "  âœ“ Refactored to reduce unsafe surface area"
            echo ""
            echo "âœ… PASSED with celebration! ğŸš€"
            
          else
            echo ""
            echo "âœ… PASSED: No change in unsafe code count"
            echo ""
            echo "The unsafe code footprint remains stable."
          fi
